# .github/workflows/ci-cd.yml
name: Smart FAST Multi-Service CI/CD Pipeline

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'services/**'
  push:
    branches: [ main ]
    paths:
      - 'services/**'

permissions:
  contents: read
  pull-requests: write
  checks: write
  actions: read
  packages: write
  id-token: write

env:
  REGISTRY: 23acr.azurecr.io
  AKS_CLUSTER_NAME: 23-aks
  AKS_RESOURCE_GROUP: 23-rsrc

jobs:
  # Î≥ÄÍ≤ΩÎêú ÏÑúÎπÑÏä§ Í∞êÏßÄ
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.changes.outputs.services }}
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      detection_method: ${{ steps.changes.outputs.detection_method }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed services
        id: changes
        run: |
          CHANGED_SERVICES=""
          DETECTION_METHOD=""
          
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # PR Ï†úÎ™©ÏóêÏÑú ÏÑúÎπÑÏä§Î™Ö Ï∂îÏ∂ú
            PR_TITLE="${{ github.event.pull_request.title }}"
            SERVICE_NAME=$(echo "$PR_TITLE" | sed -n 's/^[^/]*\/[0-9]\+\/\([^:]*\):.*/\1/p' | sed 's/[[:space:]]*$//' | tr -cd '[:alnum:]-')
          
            echo "üîç PR Title: $PR_TITLE"
            echo "üîç Parsed Service: '$SERVICE_NAME'"
            echo "üîç Length: ${#SERVICE_NAME}"
          
            # ÏÑúÎπÑÏä§ ÎîîÎ†âÌÜ†Î¶¨ ÌôïÏù∏
            if [ -d "services/$SERVICE_NAME" ]; then
              echo "‚úÖ Service directory found: services/$SERVICE_NAME"
              SERVICES="$SERVICE_NAME"
            else
              echo "‚ùå Service directory not found: services/$SERVICE_NAME"
              SERVICES=""
            fi
          fi
          
          # PR Ï†úÎ™©ÏóêÏÑú Í∞êÏßÄ Ïã§Ìå®ÌïòÍ±∞ÎÇò Push Ïù¥Î≤§Ìä∏Ïù∏ Í≤ΩÏö∞ git diff ÏÇ¨Ïö©
          if [ -z "$CHANGED_SERVICES" ]; then
            echo "üîç Using git diff to detect changes..."
            if [ "${{ github.event_name }}" == "pull_request" ]; then
              BASE_SHA="${{ github.event.pull_request.base.sha }}"
              HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            else
              BASE_SHA="${{ github.event.before }}"
              HEAD_SHA="${{ github.sha }}"
            fi
          
            # Î≥ÄÍ≤ΩÎêú ÏÑúÎπÑÏä§ ÎîîÎ†âÌÜ†Î¶¨ Ï∞æÍ∏∞
            CHANGED_SERVICES=$(git diff --name-only $BASE_SHA $HEAD_SHA | grep '^services/' | cut -d'/' -f2 | sort -u | tr '\n' ' ')
            DETECTION_METHOD="git_diff"
          
            if [ -z "$CHANGED_SERVICES" ]; then
              echo "üì≠ No services changed"
            else
              echo "üì¶ Services changed: $CHANGED_SERVICES"
            fi
          fi
          
          echo "services=$CHANGED_SERVICES" >> $GITHUB_OUTPUT
          echo "detection_method=$DETECTION_METHOD" >> $GITHUB_OUTPUT

      - name: Set matrix for changed services
        id: set-matrix
        run: |
          SERVICES="${{ steps.changes.outputs.services }}"
          if [ -z "$SERVICES" ]; then
            echo "matrix=[]" >> $GITHUB_OUTPUT
          else
            # JSON Î∞∞Ïó¥ ÌòïÌÉúÎ°ú Î≥ÄÌôò
            MATRIX_JSON=$(echo $SERVICES | tr ' ' '\n' | jq -R . | jq -s -c .)
            echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          fi
          
          echo "üéØ Final matrix: $MATRIX_JSON"

  # Í∞Å ÏÑúÎπÑÏä§Î≥Ñ ÌÖåÏä§Ìä∏ Î∞è Î¶∞ÌåÖ
  test-and-lint:
    needs: detect-changes
    if: github.event_name == 'pull_request' && needs.detect-changes.outputs.services != ''
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Check if service directory exists
        id: check-service
        run: |
          if [ -d "services/${{ matrix.service }}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Service directory services/${{ matrix.service }} does not exist"
          fi

      - name: Set environment variable for ${{ matrix.service }}
        if: steps.check-service.outputs.exists == 'true'
        run: |
          echo "AZURE_CONNECTION_STRING=${{ secrets.AZURE_CONNECTION_STRING }}" >> $GITHUB_ENV

      - name: Install dependencies for ${{ matrix.service }}
        if: steps.check-service.outputs.exists == 'true'
        working-directory: services/${{ matrix.service }}
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install pytest pytest-cov flake8 mypy

      - name: Linting (Flake8) - ${{ matrix.service }}
        id: lint
        if: steps.check-service.outputs.exists == 'true'
        working-directory: services/${{ matrix.service }}
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics > flake8-results.txt 2>&1 || true
          LINT_ERRORS=$(grep -c "E9\|F63\|F7\|F82" flake8-results.txt 2>/dev/null || echo "0")
          
          # ÏïàÏ†ÑÌïòÍ≤å output Ïì∞Í∏∞
          {
            echo "lint_errors=${LINT_ERRORS}"
            echo "service_name=${{ matrix.service }}"
          } >> "$GITHUB_OUTPUT"

      - name: Run tests with coverage - ${{ matrix.service }}
        id: test
        if: steps.check-service.outputs.exists == 'true'
        working-directory: services/${{ matrix.service }}
        run: |
          if [ -f "test_*.py" ] || [ -d "tests" ]; then
            pytest --cov=. --cov-report=xml --cov-report=term-missing --junitxml=test-results.xml || true
          
            # ÌÖåÏä§Ìä∏ Í≤∞Í≥º ÌååÏã±
            if [ -f test-results.xml ]; then
              TOTAL=$(grep -o 'tests="[^"]*"' test-results.xml | grep -o '[0-9]*' || echo "0")
              FAILURES=$(grep -o 'failures="[^"]*"' test-results.xml | grep -o '[0-9]*' || echo "0")
              ERRORS=$(grep -o 'errors="[^"]*"' test-results.xml | grep -o '[0-9]*' || echo "0")
              SKIPPED=$(grep -o 'skipped="[^"]*"' test-results.xml | grep -o '[0-9]*' || echo "0")
              PASSED=$((TOTAL - FAILURES - ERRORS))
            else
              TOTAL=0; PASSED=0; FAILURES=0; ERRORS=0; SKIPPED=0
            fi
          
            # Ïª§Î≤ÑÎ¶¨ÏßÄ ÌååÏã±
            if [ -f coverage.xml ]; then
              COVERAGE=$(grep -o 'line-rate="[^"]*"' coverage.xml | head -1 | grep -o '[0-9.]*' | awk '{print int($1*100)}' || echo "0")
            else
              COVERAGE="0"
            fi
          
            echo "total_tests=$TOTAL" >> $GITHUB_OUTPUT
            echo "passed_tests=$PASSED" >> $GITHUB_OUTPUT
            echo "failed_tests=$((FAILURES + ERRORS))" >> $GITHUB_OUTPUT
            echo "skipped_tests=$SKIPPED" >> $GITHUB_OUTPUT
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
            echo "service_name=${{ matrix.service }}" >> $GITHUB_OUTPUT
          else
            echo "No tests found for ${{ matrix.service }}"
            echo "total_tests=0" >> $GITHUB_OUTPUT
            echo "service_name=${{ matrix.service }}" >> $GITHUB_OUTPUT
          fi

      - name: Upload test results - ${{ matrix.service }}
        if: steps.check-service.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.service }}
          path: |
            services/${{ matrix.service }}/test-results.xml
            services/${{ matrix.service }}/coverage.xml
            services/${{ matrix.service }}/flake8-results.txt
      

  # Í∞Å ÏÑúÎπÑÏä§Î≥Ñ Î≥¥Ïïà Ïä§Ï∫î
  security-scan:
    needs: detect-changes
    if: github.event_name == 'pull_request' && needs.detect-changes.outputs.services != ''
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Run Bandit security scan - ${{ matrix.service }}
        id: security
        working-directory: services/${{ matrix.service }}
        run: |
          pip install bandit
          bandit -r . -f json -o bandit-report.json || true
          
          # Î≥¥Ïïà Ïù¥Ïäà ÌååÏã±
          if [ -f bandit-report.json ]; then
            HIGH=$(jq '[.results[] | select(.issue_severity=="HIGH")] | length' bandit-report.json || echo "0")
            MEDIUM=$(jq '[.results[] | select(.issue_severity=="MEDIUM")] | length' bandit-report.json || echo "0")
            LOW=$(jq '[.results[] | select(.issue_severity=="LOW")] | length' bandit-report.json || echo "0")
            TOTAL=$((HIGH + MEDIUM + LOW))
          else
            HIGH=0; MEDIUM=0; LOW=0; TOTAL=0
          fi

          echo "high_issues=$HIGH" >> $GITHUB_OUTPUT
          echo "medium_issues=$MEDIUM" >> $GITHUB_OUTPUT
          echo "low_issues=$LOW" >> $GITHUB_OUTPUT
          echo "total_issues=$TOTAL" >> $GITHUB_OUTPUT
          echo "service_name=${{ matrix.service }}" >> $GITHUB_OUTPUT

      - name: Upload security scan results - ${{ matrix.service }}
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-${{ matrix.service }}
          path: services/${{ matrix.service }}/bandit-report.json


  # Í≤∞Í≥º ÌÜµÌï© Job Ï∂îÍ∞Ä
  aggregate-results:
    needs: [ detect-changes, test-and-lint, security-scan ]
    if: github.event_name == 'pull_request' && always() && needs.detect-changes.outputs.services != ''
    runs-on: ubuntu-latest
    outputs:
      total_tests: ${{ steps.aggregate.outputs.total_tests }}
      passed_tests: ${{ steps.aggregate.outputs.passed_tests }}
      failed_tests: ${{ steps.aggregate.outputs.failed_tests }}
      skipped_tests: ${{ steps.aggregate.outputs.skipped_tests }}
      coverage: ${{ steps.aggregate.outputs.coverage }}
      lint_errors: ${{ steps.aggregate.outputs.lint_errors }}
      high_issues: ${{ steps.aggregate.outputs.high_issues }}
      medium_issues: ${{ steps.aggregate.outputs.medium_issues }}
      low_issues: ${{ steps.aggregate.outputs.low_issues }}
      total_issues: ${{ steps.aggregate.outputs.total_issues }}
      failed_test_names: ${{ steps.aggregate.outputs.failed_test_names }}

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Aggregate results
        id: aggregate
        run: |
          # Î™®Îì† ÌÖåÏä§Ìä∏ Í≤∞Í≥º ÌÜµÌï©
          TOTAL_TESTS=0
          PASSED_TESTS=0
          FAILED_TESTS=0
          SKIPPED_TESTS=0
          TOTAL_LINT_ERRORS=0
          TOTAL_HIGH=0
          TOTAL_MEDIUM=0
          TOTAL_LOW=0
          FAILED_TEST_NAMES=""
          TOTAL_COVERAGE=0
          SERVICE_COUNT=0

          # Í∞Å ÏÑúÎπÑÏä§Î≥Ñ Í≤∞Í≥º ÏßëÍ≥Ñ
          for dir in test-results-*; do
            if [ -d "$dir" ]; then
              SERVICE_COUNT=$((SERVICE_COUNT + 1))

              # ÌÖåÏä§Ìä∏ Í≤∞Í≥º ÌååÏã± (artifactÏóêÏÑú)
              if [ -f "$dir/test-results.xml" ]; then
                T=$(grep -o 'tests="[^"]*"' "$dir/test-results.xml" | grep -o '[0-9]*' || echo "0")
                F=$(grep -o 'failures="[^"]*"' "$dir/test-results.xml" | grep -o '[0-9]*' || echo "0")
                E=$(grep -o 'errors="[^"]*"' "$dir/test-results.xml" | grep -o '[0-9]*' || echo "0")
                S=$(grep -o 'skipped="[^"]*"' "$dir/test-results.xml" | grep -o '[0-9]*' || echo "0")

                TOTAL_TESTS=$((TOTAL_TESTS + T))
                FAILED_TESTS=$((FAILED_TESTS + F + E))
                SKIPPED_TESTS=$((SKIPPED_TESTS + S))
                PASSED_TESTS=$((PASSED_TESTS + T - F - E))

                # Ïã§Ìå®Ìïú ÌÖåÏä§Ìä∏ Ïù¥Î¶Ñ ÏàòÏßë
                if [ $((F + E)) -gt 0 ]; then
                  SERVICE_NAME=$(echo "$dir" | sed 's/test-results-//')
                  FAILED_TEST_NAMES="$FAILED_TEST_NAMES,$SERVICE_NAME"
                fi
              fi

              # Ïª§Î≤ÑÎ¶¨ÏßÄ ÏßëÍ≥Ñ
              if [ -f "$dir/coverage.xml" ]; then
                COV=$(grep -o 'line-rate="[^"]*"' "$dir/coverage.xml" | head -1 | grep -o '[0-9.]*' | awk '{print $1*100}' || echo "0")
                TOTAL_COVERAGE=$((TOTAL_COVERAGE + COV))
              fi

              # Î¶∞Ìä∏ Ïò§Î•ò ÏßëÍ≥Ñ
              if [ -f "$dir/flake8-results.txt" ]; then
                LINT_ERR=$(grep -c "E9\|F63\|F7\|F82" "$dir/flake8-results.txt" || echo "0")
                TOTAL_LINT_ERRORS=$((TOTAL_LINT_ERRORS + LINT_ERR))
              fi
            fi
          done

          # Î≥¥Ïïà Ïä§Ï∫î Í≤∞Í≥º ÏßëÍ≥Ñ
          for dir in security-scan-*; do
            if [ -d "$dir" ] && [ -f "$dir/bandit-report.json" ]; then
              H=$(jq '[.results[] | select(.issue_severity=="HIGH")] | length' "$dir/bandit-report.json" || echo "0")
              M=$(jq '[.results[] | select(.issue_severity=="MEDIUM")] | length' "$dir/bandit-report.json" || echo "0")
              L=$(jq '[.results[] | select(.issue_severity=="LOW")] | length' "$dir/bandit-report.json" || echo "0")

              TOTAL_HIGH=$((TOTAL_HIGH + H))
              TOTAL_MEDIUM=$((TOTAL_MEDIUM + M))
              TOTAL_LOW=$((TOTAL_LOW + L))
            fi
          done

          # ÌèâÍ∑† Ïª§Î≤ÑÎ¶¨ÏßÄ Í≥ÑÏÇ∞
          if [ $SERVICE_COUNT -gt 0 ]; then
            AVG_COVERAGE=$((TOTAL_COVERAGE / SERVICE_COUNT))
          else
            AVG_COVERAGE=0
          fi

          # Outputs ÏÑ§Ï†ï
          echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "passed_tests=$PASSED_TESTS" >> $GITHUB_OUTPUT
          echo "failed_tests=$FAILED_TESTS" >> $GITHUB_OUTPUT
          echo "skipped_tests=$SKIPPED_TESTS" >> $GITHUB_OUTPUT
          echo "coverage=$AVG_COVERAGE" >> $GITHUB_OUTPUT
          echo "lint_errors=$TOTAL_LINT_ERRORS" >> $GITHUB_OUTPUT
          echo "high_issues=$TOTAL_HIGH" >> $GITHUB_OUTPUT
          echo "medium_issues=$TOTAL_MEDIUM" >> $GITHUB_OUTPUT
          echo "low_issues=$TOTAL_LOW" >> $GITHUB_OUTPUT
          echo "total_issues=$((TOTAL_HIGH + TOTAL_MEDIUM + TOTAL_LOW))" >> $GITHUB_OUTPUT
          echo "failed_test_names=${FAILED_TEST_NAMES#,}" >> $GITHUB_OUTPUT

  # Í∞Å ÏÑúÎπÑÏä§Î≥Ñ Docker ÎπåÎìú Î∞è Ìë∏Ïãú (main Î∏åÎûúÏπòÎßå)
  build-and-push:
    needs: detect-changes
    if: github.ref == 'refs/heads/main' && needs.detect-changes.outputs.services != ''
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Check if Dockerfile exists for ${{ matrix.service }}
        id: dockerfile-check
        run: |
          if [ -f "services/${{ matrix.service }}/Dockerfile" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Dockerfile not found for services/${{ matrix.service }}"
          fi

      - name: Login to Azure Container Registry
        if: steps.dockerfile-check.outputs.exists == 'true'
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push Docker image - ${{ matrix.service }}
        if: steps.dockerfile-check.outputs.exists == 'true'
        working-directory: services/${{ matrix.service }}
        run: |
          IMAGE_NAME="smart-fast-${{ matrix.service }}"
          docker build -t ${{ env.REGISTRY }}/${IMAGE_NAME}:${{ github.sha }} .
          docker build -t ${{ env.REGISTRY }}/${IMAGE_NAME}:latest .
          docker push ${{ env.REGISTRY }}/${IMAGE_NAME}:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/${IMAGE_NAME}:latest
          
          echo "Built and pushed image: ${{ env.REGISTRY }}/${IMAGE_NAME}:${{ github.sha }}"

  # Í∞Å ÏÑúÎπÑÏä§Î≥Ñ AKS Î∞∞Ìè¨
  deploy-to-aks:
    needs: [detect-changes, build-and-push]
    if: github.ref == 'refs/heads/main' && needs.detect-changes.outputs.services != ''
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS credentials
        run: |
          az aks get-credentials --resource-group ${{ env.AKS_RESOURCE_GROUP }} --name ${{ env.AKS_CLUSTER_NAME }}

      - name: Check if k8s manifests exist for ${{ matrix.service }}
        id: k8s-check
        run: |
          if [ -d "services/${{ matrix.service }}/k8s" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "k8s_path=services/${{ matrix.service }}/k8s" >> $GITHUB_OUTPUT
          elif [ -d "k8s/common" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "k8s_path=k8s/common" >> $GITHUB_OUTPUT
            echo "üì¶ Using unified AI-friendly manifests"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Kubernetes manifests not found for ${{ matrix.service }}"
          fi

      - name: Deploy to AKS - ${{ matrix.service }}
        if: steps.k8s-check.outputs.exists == 'true'
        run: |
          # ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï
          export SERVICE_NAME="${{ matrix.service }}"
          export IMAGE_TAG="${{ github.sha }}"
          export REGISTRY="${{ env.REGISTRY }}"
          export IMAGE_FULL_NAME="${{ env.REGISTRY }}/smart-fast-${{ matrix.service }}:${{ github.sha }}"

          case "${{ matrix.service }}" in
            "painting-process-equipment-defect-detection-model-service")
              export SERVICE_PORT="8001"
              ;; 

            "painting-surface-defect-detection-model-service")
              export SERVICE_PORT="8002"
              ;; 
            
            "press-defect-detection-model-service")
              export SERVICE_PORT="8003"
              ;; 

            "press-fault-detection-model-service")
              export SERVICE_PORT="8004"
              ;; 

            "vehicle-assembly-process-defect-detection-model-service")
              export SERVICE_PORT="8005"
              ;; 

            "welding-machine-defect-detection-model-service")
              export SERVICE_PORT="8006"
              ;; 

            "welding-machine-data-simulator-service")
              export SERVICE_PORT="8016"
              ;; 

            "vehicle-assembly-data-simulator-service")
              export SERVICE_PORT="8015"
              ;; 

            "press-fault-data-simulator-service")
              export SERVICE_PORT="8014"
              ;; 

            "press-defect-data-simulator-service")
              export SERVICE_PORT="8013"
              ;; 

            "painting-surface-data-simulator-service")
              export SERVICE_PORT="8012"
              ;; 

            "painting-process-data-simulator-service")
              export SERVICE_PORT="8011"
              ;; 

             *)
              export SERVICE_PORT="8000"  # Í∏∞Î≥∏Í∞í
              ;;
          esac

          echo "üöÄ Deploying ${{ matrix.service }} on port $SERVICE_PORT with minimal setup"

          # ÏàúÏ∞®Ï†ÅÏúºÎ°ú Î∞∞Ìè¨ (ÏùòÏ°¥ÏÑ± Í≥†Î†§)
          echo "üì¶ Creating namespace..."
          envsubst < k8s/common/namespace.yaml | kubectl apply -f -

          echo "üîß Deploying application..."
          envsubst < k8s/common/deployment.yaml | kubectl apply -f -

          echo "üåê Creating service..."
          envsubst < k8s/common/service.yaml | kubectl apply -f -

          echo "üåç Setting up ingress..."
          envsubst < k8s/common/ingress.yaml | kubectl apply -f -

          echo "üìà Configuring auto-scaling..."
          envsubst < k8s/common/hpa.yaml | kubectl apply -f -

          # Î∞∞Ìè¨ ÏÉÅÌÉú ÌôïÏù∏
          echo "‚è≥ Waiting for deployment to be ready..."
          kubectl rollout status deployment/sf-${{ matrix.service }} -n sf-${{ matrix.service }} --timeout=300s

          # Î∞∞Ìè¨ Í≤∞Í≥º ÌôïÏù∏
          POD_STATUS=$(kubectl get pods -n sf-${{ matrix.service }} -l app=sf-${{ matrix.service }} -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "NotFound")
          if [ "$POD_STATUS" = "Running" ]; then
            echo "‚úÖ ${{ matrix.service }} deployed successfully!"

            # Ï†ëÍ∑º URL ÏïàÎÇ¥
            EXTERNAL_IP=$(kubectl get service ingress-nginx-controller -n ingress-nginx -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "pending")
            if [ "$EXTERNAL_IP" != "pending" ] && [ ! -z "$EXTERNAL_IP" ]; then
              echo "üåê Service URL: http://$EXTERNAL_IP.nip.io/v1/${{ matrix.service }}/"
              echo "üè• Health Check: http://$EXTERNAL_IP.nip.io/health/${{ matrix.service }}"
            else
              echo "‚è≥ External IP is still being assigned. Check later with: kubectl get ingress -A"
            fi
          else
            echo "‚ö†Ô∏è Deployment may have issues. Pod status: $POD_STATUS"
            kubectl describe pods -n sf-${{ matrix.service }} -l app=sf-${{ matrix.service }}
          fi
  # Pull Request ÏûêÎèô Î¶¨Î∑∞ (Î™®Îì† Í≤ÄÏÇ¨ ÏôÑÎ£å ÌõÑ)
  auto-review:
    needs: [ detect-changes, aggregate-results ]
    if: github.event_name == 'pull_request' && needs.detect-changes.outputs.services != '' && always()
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: PR Code Review Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const changedServices = "${{ needs.detect-changes.outputs.services }}".split(' ').filter(s => s.trim());

            if (changedServices.length === 0) {
              console.log('No services detected, skipping review comment');
              return;
            }

            console.log('Changed services:', changedServices);

            try {
              const detectionMethod = "${{ needs.detect-changes.outputs.detection_method }}";
              const prTitle = "${{ github.event.pull_request.title }}";

              // Í∞Å ÏûëÏóÖÏùò Í≤∞Í≥º ÏàòÏßë
              const testResult = "${{ needs.test-and-lint.result }}";
              const securityResult = "${{ needs.security-scan.result }}";

              // ÌÖåÏä§Ìä∏ Í≤∞Í≥º ÌååÏã±
              const testOutputs = {
                total: "${{ needs.aggregate-results.outputs.total_tests || '0' }}",
                passed: "${{ needs.aggregate-results.outputs.passed_tests || '0' }}",
                failed: "${{ needs.aggregate-results.outputs.failed_tests || '0' }}",
                skipped: "${{ needs.aggregate-results.outputs.skipped_tests || '0' }}",
                coverage: "${{ needs.aggregate-results.outputs.coverage || 'N/A' }}",
                failedTests: "${{ needs.aggregate-results.outputs.failed_test_names || '' }}",
                lintErrors: "${{ needs.aggregate-results.outputs.lint_errors || '0' }}",
                lintWarnings: "${{ needs.aggregate-results.outputs.lint_warnings || '0' }}"
              };

              // Î≥¥Ïïà Ïä§Ï∫î Í≤∞Í≥º
              const securityOutputs = {
                highIssues: "${{ needs.security-scan.outputs.high_issues || '0' }}",
                mediumIssues: "${{ needs.security-scan.outputs.medium_issues || '0' }}",
                lowIssues: "${{ needs.security-scan.outputs.low_issues || '0' }}",
                totalIssues: "${{ needs.security-scan.outputs.total_issues || '0' }}",
                securityDetails: "${{ needs.security-scan.outputs.security_details || '' }}"
              };

              let reviewComment = "## ü§ñ Smart FAST ÏûêÎèô ÏΩîÎìú Î¶¨Î∑∞\n\n";
              reviewComment += `### üì¶ Î≥ÄÍ≤ΩÎêú ÏÑúÎπÑÏä§ (${changedServices.length}Í∞ú):\n`;

              changedServices.forEach(service => {
                reviewComment += `- **${service}** ÏÑúÎπÑÏä§\n`;
              });

              // Í∞êÏßÄ Î∞©Î≤ïÏóê Îî∞Î•∏ Î©îÏãúÏßÄ
              if (detectionMethod === "pr_title") {
                reviewComment += "\nüéØ **PR Ï†úÎ™©ÏóêÏÑú ÏÑúÎπÑÏä§ ÏûêÎèô Í∞êÏßÄÎê®**\n";
                reviewComment += `- Ï†úÎ™©: \`${prTitle}\`\n`;
              } else if (detectionMethod === "git_diff") {
                reviewComment += "\nüîç **Git diffÎ•º ÌÜµÌï¥ ÏÑúÎπÑÏä§ Í∞êÏßÄÎê®**\n";
              }

              // Ï†ÑÏ≤¥ ÏÉÅÌÉú ÏöîÏïΩ
              reviewComment += "\n### üìä Ï†ÑÏ≤¥ Í≤ÄÏÇ¨ Í≤∞Í≥º:\n";
              const allPassed = testResult === 'success' && securityResult === 'success';

              if (allPassed) {
                reviewComment += "‚úÖ **Î™®Îì† Í≤ÄÏÇ¨ ÌÜµÍ≥º** - Î∞∞Ìè¨ Ï§ÄÎπÑ ÏôÑÎ£å!\n";
              } else {
                reviewComment += "‚ö†Ô∏è **ÏùºÎ∂Ä Í≤ÄÏÇ¨ÏóêÏÑú Î¨∏Ï†ú Î∞úÍ≤¨** - ÌôïÏù∏ ÌïÑÏöî\n";
              }

              // ÌÖåÏä§Ìä∏ & Î¶∞Ìä∏ Í≤∞Í≥º ÏÑπÏÖò
              reviewComment += "\n### üß™ ÌÖåÏä§Ìä∏ & ÏΩîÎìú ÌíàÏßà Í≤∞Í≥º:\n";

              if (testResult === 'success') {
                reviewComment += "‚úÖ **ÌÖåÏä§Ìä∏ & Î¶∞Ìä∏ ÌÜµÍ≥º**\n";
              } else if (testResult === 'failure') {
                reviewComment += "‚ùå **ÌÖåÏä§Ìä∏ & Î¶∞Ìä∏ Ïã§Ìå®**\n";
              } else if (testResult === 'skipped') {
                reviewComment += "‚è≠Ô∏è **ÌÖåÏä§Ìä∏ & Î¶∞Ìä∏ Ïä§ÌÇµÎê®**\n";
              } else {
                reviewComment += "‚ö†Ô∏è **ÌÖåÏä§Ìä∏ & Î¶∞Ìä∏ ÏÉÅÌÉú Î∂àÎ™Ö**\n";
              }

              // ÌÖåÏä§Ìä∏ ÌÜµÍ≥Ñ
              if (testOutputs.total !== '0') {
                reviewComment += `- **Ï¥ù ÌÖåÏä§Ìä∏**: ${testOutputs.total}Í∞ú\n`;
                reviewComment += `- **ÏÑ±Í≥µ**: ${testOutputs.passed}Í∞ú ‚úÖ\n`;

                if (testOutputs.failed !== '0') {
                  reviewComment += `- **Ïã§Ìå®**: ${testOutputs.failed}Í∞ú ‚ùå\n`;
                }

                if (testOutputs.skipped !== '0') {
                  reviewComment += `- **Ïä§ÌÇµ**: ${testOutputs.skipped}Í∞ú ‚è≠Ô∏è\n`;
                }

                if (testOutputs.coverage !== 'N/A') {
                  reviewComment += `- **Ïª§Î≤ÑÎ¶¨ÏßÄ**: ${testOutputs.coverage}%\n`;
                }
              }

              // Î¶∞Ìä∏ Í≤∞Í≥º
              if (testOutputs.lintErrors !== '0' || testOutputs.lintWarnings !== '0') {
                reviewComment += `- **Î¶∞Ìä∏ Ïò§Î•ò**: ${testOutputs.lintErrors}Í∞ú\n`;
                reviewComment += `- **Î¶∞Ìä∏ Í≤ΩÍ≥†**: ${testOutputs.lintWarnings}Í∞ú\n`;
              }

              // Ïã§Ìå®Ìïú ÌÖåÏä§Ìä∏ ÏÉÅÏÑ∏ Ï†ïÎ≥¥
              if (testOutputs.failedTests) {
                reviewComment += "\n**üîç Ïã§Ìå®Ìïú ÌÖåÏä§Ìä∏:**\n";
                const failedTestsList = testOutputs.failedTests.split(',').filter(t => t.trim());
                failedTestsList.forEach(test => {
                  reviewComment += `- \`${test.trim()}\`\n`;
                });
              }

              // Î≥¥Ïïà Ïä§Ï∫î Í≤∞Í≥º ÏÑπÏÖò
              reviewComment += "\n### üîí Î≥¥Ïïà Ïä§Ï∫î Í≤∞Í≥º:\n";

              if (securityResult === 'success') {
                reviewComment += "‚úÖ **Î≥¥Ïïà Í≤ÄÏÇ¨ ÌÜµÍ≥º**\n";
              } else if (securityResult === 'failure') {
                reviewComment += "‚ùå **Î≥¥Ïïà Ïù¥Ïäà Î∞úÍ≤¨**\n";
              } else if (securityResult === 'skipped') {
                reviewComment += "‚è≠Ô∏è **Î≥¥Ïïà Ïä§Ï∫î Ïä§ÌÇµÎê®**\n";
              } else {
                reviewComment += "‚ö†Ô∏è **Î≥¥Ïïà Ïä§Ï∫î ÏÉÅÌÉú Î∂àÎ™Ö**\n";
              }

              if (securityOutputs.totalIssues !== '0') {
                reviewComment += `- **Ï¥ù Î≥¥Ïïà Ïù¥Ïäà**: ${securityOutputs.totalIssues}Í∞ú\n`;

                if (securityOutputs.highIssues !== '0') {
                  reviewComment += `  - üî¥ **High**: ${securityOutputs.highIssues}Í∞ú\n`;
                }
                if (securityOutputs.mediumIssues !== '0') {
                  reviewComment += `  - üü° **Medium**: ${securityOutputs.mediumIssues}Í∞ú\n`;
                }
                if (securityOutputs.lowIssues !== '0') {
                  reviewComment += `  - üü¢ **Low**: ${securityOutputs.lowIssues}Í∞ú\n`;
                }

                // Î≥¥Ïïà Ïù¥Ïäà ÏÉÅÏÑ∏ Ï†ïÎ≥¥
                if (securityOutputs.securityDetails) {
                  reviewComment += "\n**üö® Ï£ºÏöî Î≥¥Ïïà Ïù¥Ïäà:**\n";
                  const securityDetailsList = securityOutputs.securityDetails.split(',').filter(d => d.trim());
                  securityDetailsList.forEach(detail => {
                    reviewComment += `- ${detail.trim()}\n`;
                  });
                }
              } else {
                reviewComment += "- Î≥¥Ïïà Ïù¥ÏäàÍ∞Ä Î∞úÍ≤¨ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§ ‚úÖ\n";
              }

              // Ï¢ÖÌï© Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏
              reviewComment += "\n### ‚úÖ Í≤ÄÏÇ¨ Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏:\n";
              reviewComment += testResult === 'success' ? 
                "- ‚úÖ ÌÖåÏä§Ìä∏ ÌÜµÍ≥º\n" : 
                "- ‚ùå ÌÖåÏä§Ìä∏ Ïã§Ìå®\n";
              reviewComment += testOutputs.lintErrors === '0' ? 
                "- ‚úÖ ÏΩîÎìú ÌíàÏßà Í≤ÄÏÇ¨ ÌÜµÍ≥º\n" : 
                "- ‚ùå Î¶∞Ìä∏ Ïò§Î•ò Î∞úÍ≤¨\n";
              reviewComment += securityResult === 'success' ? 
                "- ‚úÖ Î≥¥Ïïà Ïä§Ï∫î ÌÜµÍ≥º\n" : 
                "- ‚ùå Î≥¥Ïïà Ïù¥Ïäà Î∞úÍ≤¨\n";

              // Î∞∞Ìè¨ Ï†ïÎ≥¥
              reviewComment += "\n### üöÄ Î∞∞Ìè¨ Ï†ïÎ≥¥:\n";
              if (allPassed) {
                reviewComment += "- ‚úÖ **Î™®Îì† Í≤ÄÏÇ¨ ÌÜµÍ≥º** - Î∞∞Ìè¨ Ï§ÄÎπÑ ÏôÑÎ£å\n";
                reviewComment += "- üîÑ main Î∏åÎûúÏπò Î®∏ÏßÄ Ïãú ÏûêÎèô Î∞∞Ìè¨Îê©ÎãàÎã§\n";
                reviewComment += "- üèóÔ∏è Í∞Å ÏÑúÎπÑÏä§Îäî ÎèÖÎ¶ΩÏ†ÅÏúºÎ°ú ÎπåÎìú/Î∞∞Ìè¨Îê©ÎãàÎã§\n";
              } else {
                reviewComment += "- ‚ö†Ô∏è **Í≤ÄÏÇ¨ Ïã§Ìå®** - Î¨∏Ï†ú Ìï¥Í≤∞ ÌõÑ Î∞∞Ìè¨ Í∞ÄÎä•\n";
                if (testResult !== 'success') {
                  reviewComment += "  - üß™ ÌÖåÏä§Ìä∏ Î¨∏Ï†ú Ìï¥Í≤∞ ÌïÑÏöî\n";
                }
                if (securityResult !== 'success') {
                  reviewComment += "  - üîí Î≥¥Ïïà Ïù¥Ïäà Ìï¥Í≤∞ ÌïÑÏöî\n";
                }
              }
              reviewComment += "- üìã ÏÉÅÏÑ∏ Î°úÍ∑∏Îäî Actions ÌÉ≠ÏóêÏÑú ÌôïÏù∏ Í∞ÄÎä•\n";

              // Í∏∞Ï°¥ ÏûêÎèô Î¶¨Î∑∞ ÏΩîÎ©òÌä∏Í∞Ä ÏûàÎäîÏßÄ ÌôïÏù∏ÌïòÍ≥† ÏóÖÎç∞Ïù¥Ìä∏
              const { data: comments } = await github.rest.issues.listComments({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
              });

              const botComment = comments.find(comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes('ü§ñ Smart FAST ÏûêÎèô ÏΩîÎìú Î¶¨Î∑∞')
              );

              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: reviewComment
                });
                console.log('Updated existing review comment');
              } else {
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: reviewComment
                });
                console.log('Created new review comment');
              }

            } catch (error) {
              console.error('Error creating review comment:', error);
              process.exit(0);
            }
