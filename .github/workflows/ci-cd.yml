# .github/workflows/ci-cd.yml
name: Smart FAST Multi-Service CI/CD Pipeline

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'services/**'
  push:
    branches: [ main ]
    paths:
      - 'services/**'

env:
  REGISTRY: 23acr.azurecr.io
  AKS_CLUSTER_NAME: 23-aks
  AKS_RESOURCE_GROUP: 23-rsrc

jobs:
  # ë³€ê²½ëœ ì„œë¹„ìŠ¤ ê°ì§€
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.changes.outputs.services }}
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      detection_method: ${{ steps.changes.outputs.detection_method }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed services
        id: changes
        run: |
          CHANGED_SERVICES=""
          DETECTION_METHOD=""
          
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # PR ì œëª©ì—ì„œ ì„œë¹„ìŠ¤ëª… ì¶”ì¶œ ì‹œë„
            PR_TITLE="${{ github.event.pull_request.title }}"
            echo "ğŸ” PR Title: $PR_TITLE"
          
            # PR ì œëª© íŒ¨í„´: {PREFIX}/{issuecode}/{service-name} : ì„¤ëª…
            if [[ $PR_TITLE =~ ^([^/]+)/([^/]+)/([^/\s:]+) ]]; then
              PREFIX_FROM_TITLE="${BASH_REMATCH[1]}"
              ISSUE_FROM_TITLE="${BASH_REMATCH[2]}"
              SERVICE_FROM_TITLE="${BASH_REMATCH[3]}"
              echo "ğŸ“¦ Prefix: $PREFIX_FROM_TITLE, Issue: $ISSUE_FROM_TITLE, Service: $SERVICE_FROM_TITLE"
          
              # í•´ë‹¹ ì„œë¹„ìŠ¤ ë””ë ‰í† ë¦¬ê°€ ì‹¤ì œë¡œ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
              if [ -d "services/$SERVICE_FROM_TITLE" ]; then
                CHANGED_SERVICES="$SERVICE_FROM_TITLE"
                DETECTION_METHOD="pr_title"
                echo "âœ… Service directory confirmed: services/$SERVICE_FROM_TITLE"
              else
                echo "âš ï¸ Service directory not found: services/$SERVICE_FROM_TITLE"
                echo "ğŸ”„ Falling back to git diff detection..."
              fi
            else
              echo "âš ï¸ PR title doesn't match pattern {PREFIX}/{issuecode}/{service-name} : description"
              echo "ğŸ”„ Falling back to git diff detection..."
            fi
          fi
          
          # PR ì œëª©ì—ì„œ ê°ì§€ ì‹¤íŒ¨í•˜ê±°ë‚˜ Push ì´ë²¤íŠ¸ì¸ ê²½ìš° git diff ì‚¬ìš©
          if [ -z "$CHANGED_SERVICES" ]; then
            echo "ğŸ” Using git diff to detect changes..."
            if [ "${{ github.event_name }}" == "pull_request" ]; then
              BASE_SHA="${{ github.event.pull_request.base.sha }}"
              HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            else
              BASE_SHA="${{ github.event.before }}"
              HEAD_SHA="${{ github.sha }}"
            fi
          
            # ë³€ê²½ëœ ì„œë¹„ìŠ¤ ë””ë ‰í† ë¦¬ ì°¾ê¸°
            CHANGED_SERVICES=$(git diff --name-only $BASE_SHA $HEAD_SHA | grep '^services/' | cut -d'/' -f2 | sort -u | tr '\n' ' ')
            DETECTION_METHOD="git_diff"
          
            if [ -z "$CHANGED_SERVICES" ]; then
              echo "ğŸ“­ No services changed"
            else
              echo "ğŸ“¦ Services changed: $CHANGED_SERVICES"
            fi
          fi
          
          echo "services=$CHANGED_SERVICES" >> $GITHUB_OUTPUT
          echo "detection_method=$DETECTION_METHOD" >> $GITHUB_OUTPUT

      - name: Set matrix for changed services
        id: set-matrix
        run: |
          SERVICES="${{ steps.changes.outputs.services }}"
          if [ -z "$SERVICES" ]; then
            echo "matrix=[]" >> $GITHUB_OUTPUT
          else
            # JSON ë°°ì—´ í˜•íƒœë¡œ ë³€í™˜
            MATRIX_JSON=$(echo $SERVICES | tr ' ' '\n' | jq -R . | jq -s -c .)
            echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          fi
          
          echo "ğŸ¯ Final matrix: $MATRIX_JSON"

  # ê° ì„œë¹„ìŠ¤ë³„ í…ŒìŠ¤íŠ¸ ë° ë¦°íŒ…
  test-and-lint:
    needs: detect-changes
    if: needs.detect-changes.outputs.services != ''
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Check if service directory exists
        id: check-service
        run: |
          if [ -d "services/${{ matrix.service }}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Service directory services/${{ matrix.service }} does not exist"
          fi

      - name: Install dependencies for ${{ matrix.service }}
        if: steps.check-service.outputs.exists == 'true'
        working-directory: services/${{ matrix.service }}
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install pytest pytest-cov flake8 mypy

      - name: Linting (Flake8) - ${{ matrix.service }}
        if: steps.check-service.outputs.exists == 'true'
        working-directory: services/${{ matrix.service }}
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: Type checking (MyPy) - ${{ matrix.service }}
        if: steps.check-service.outputs.exists == 'true'
        working-directory: services/${{ matrix.service }}
        run: mypy . --ignore-missing-imports

      - name: Run tests with coverage - ${{ matrix.service }}
        if: steps.check-service.outputs.exists == 'true'
        working-directory: services/${{ matrix.service }}
        run: |
          if [ -f "test_*.py" ] || [ -d "tests" ]; then
            pytest --cov=. --cov-report=xml --cov-report=term-missing
          else
            echo "No tests found for ${{ matrix.service }}"
          fi

      - name: Upload coverage to Codecov - ${{ matrix.service }}
        if: steps.check-service.outputs.exists == 'true'
        uses: codecov/codecov-action@v3
        with:
          file: ./services/${{ matrix.service }}/coverage.xml
          flags: ${{ matrix.service }}
          name: ${{ matrix.service }}-coverage

  # ê° ì„œë¹„ìŠ¤ë³„ ë³´ì•ˆ ìŠ¤ìº”
  security-scan:
    needs: detect-changes
    if: needs.detect-changes.outputs.services != ''
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Run Bandit security scan - ${{ matrix.service }}
        working-directory: services/${{ matrix.service }}
        run: |
          pip install bandit
          bandit -r . -f json -o bandit-report.json || true

      - name: Upload security scan results - ${{ matrix.service }}
        uses: actions/upload-artifact@v3
        with:
          name: security-scan-${{ matrix.service }}
          path: services/${{ matrix.service }}/bandit-report.json

  # ê° ì„œë¹„ìŠ¤ë³„ Docker ë¹Œë“œ ë° í‘¸ì‹œ (main ë¸Œëœì¹˜ë§Œ)
  build-and-push:
    needs: [detect-changes, test-and-lint, security-scan]
    if: github.ref == 'refs/heads/main' && needs.detect-changes.outputs.services != ''
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Check if Dockerfile exists for ${{ matrix.service }}
        id: dockerfile-check
        run: |
          if [ -f "services/${{ matrix.service }}/Dockerfile" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Dockerfile not found for services/${{ matrix.service }}"
          fi

      - name: Login to Azure Container Registry
        if: steps.dockerfile-check.outputs.exists == 'true'
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push Docker image - ${{ matrix.service }}
        if: steps.dockerfile-check.outputs.exists == 'true'
        working-directory: services/${{ matrix.service }}
        run: |
          IMAGE_NAME="smart-fast-${{ matrix.service }}"
          docker build -t ${{ env.REGISTRY }}/${IMAGE_NAME}:${{ github.sha }} .
          docker build -t ${{ env.REGISTRY }}/${IMAGE_NAME}:latest .
          docker push ${{ env.REGISTRY }}/${IMAGE_NAME}:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/${IMAGE_NAME}:latest
          
          echo "Built and pushed image: ${{ env.REGISTRY }}/${IMAGE_NAME}:${{ github.sha }}"

  # ê° ì„œë¹„ìŠ¤ë³„ AKS ë°°í¬
  deploy-to-aks:
    needs: [detect-changes, build-and-push]
    if: github.ref == 'refs/heads/main' && needs.detect-changes.outputs.services != ''
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS credentials
        run: |
          az aks get-credentials --resource-group ${{ env.AKS_RESOURCE_GROUP }} --name ${{ env.AKS_CLUSTER_NAME }}

      - name: Check if k8s manifests exist for ${{ matrix.service }}
        id: k8s-check
        run: |
          if [ -d "services/${{ matrix.service }}/k8s" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "k8s_path=services/${{ matrix.service }}/k8s" >> $GITHUB_OUTPUT
          elif [ -d "k8s/common" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "k8s_path=k8s/common" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Using unified AI-friendly manifests"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Kubernetes manifests not found for ${{ matrix.service }}"
          fi

      - name: Deploy to AKS - ${{ matrix.service }}
        if: steps.k8s-check.outputs.exists == 'true'
        run: |
          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          export SERVICE_NAME="${{ matrix.service }}"
          export IMAGE_TAG="${{ github.sha }}"
          export REGISTRY="${{ env.REGISTRY }}"
          export IMAGE_FULL_NAME="${{ env.REGISTRY }}/smart-fast-${{ matrix.service }}:${{ github.sha }}"

          echo "ğŸš€ Deploying ${{ matrix.service }} with minimal setup"

          # ìˆœì°¨ì ìœ¼ë¡œ ë°°í¬ (ì˜ì¡´ì„± ê³ ë ¤)
          echo "ğŸ“¦ Creating namespace..."
          envsubst < k8s/common/1-namespace.yaml | kubectl apply -f -

          echo "ğŸ”§ Deploying application..."
          envsubst < k8s/common/2-deployment.yaml | kubectl apply -f -

          echo "ğŸŒ Creating service..."
          envsubst < k8s/common/3-service.yaml | kubectl apply -f -

          echo "ğŸŒ Setting up ingress..."
          envsubst < k8s/common/4-ingress.yaml | kubectl apply -f -

          echo "ğŸ“ˆ Configuring auto-scaling..."
          envsubst < k8s/common/5-hpa.yaml | kubectl apply -f -

          # ë°°í¬ ìƒíƒœ í™•ì¸
          echo "â³ Waiting for deployment to be ready..."
          kubectl rollout status deployment/smart-fast-${{ matrix.service }} -n smart-fast-${{ matrix.service }} --timeout=300s

          # ë°°í¬ ê²°ê³¼ í™•ì¸
          POD_STATUS=$(kubectl get pods -n smart-fast-${{ matrix.service }} -l app=smart-fast-${{ matrix.service }} -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "NotFound")
          if [ "$POD_STATUS" = "Running" ]; then
            echo "âœ… ${{ matrix.service }} deployed successfully!"

            # ì ‘ê·¼ URL ì•ˆë‚´
            EXTERNAL_IP=$(kubectl get service ingress-nginx-controller -n ingress-nginx -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "pending")
            if [ "$EXTERNAL_IP" != "pending" ] && [ ! -z "$EXTERNAL_IP" ]; then
              echo "ğŸŒ Service URL: http://$EXTERNAL_IP.nip.io/v1/${{ matrix.service }}/"
              echo "ğŸ¥ Health Check: http://$EXTERNAL_IP.nip.io/health/${{ matrix.service }}"
            else
              echo "â³ External IP is still being assigned. Check later with: kubectl get ingress -A"
            fi
          else
            echo "âš ï¸ Deployment may have issues. Pod status: $POD_STATUS"
            kubectl describe pods -n smart-fast-${{ matrix.service }} -l app=smart-fast-${{ matrix.service }}
          fi

  # Pull Request ìë™ ë¦¬ë·° (ë³€ê²½ëœ ì„œë¹„ìŠ¤ë³„ë¡œ)
  auto-review:
    needs: detect-changes
    if: github.event_name == 'pull_request' && needs.detect-changes.outputs.services != ''
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: PR Code Review Comment
        uses: actions/github-script@v6
        with:
          script: |
            const changedServices = "${{ needs.detect-changes.outputs.services }}".split(' ').filter(s => s);
            
            if (changedServices.length === 0) {
              return;
            }
            
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            const detectionMethod = "${{ needs.detect-changes.outputs.detection_method }}";
            
            let reviewComment = "## ğŸ¤– Smart FAST ìë™ ì½”ë“œ ë¦¬ë·°\n\n";
            reviewComment += `### ğŸ“¦ ë³€ê²½ëœ ì„œë¹„ìŠ¤ (${changedServices.length}ê°œ):\n`;
            
            changedServices.forEach(service => {
              reviewComment += `- **${service}** ì„œë¹„ìŠ¤\n`;
            });
            
            if (detectionMethod === "pr_title") {
              reviewComment += "\nğŸ¯ **PR ì œëª©ì—ì„œ ì„œë¹„ìŠ¤ ìë™ ê°ì§€ë¨** ({PREFIX}/{issuecode}/{service-name})\n";
            } else if (detectionMethod === "git_diff") {
              reviewComment += "\nğŸ” **Git diffë¥¼ í†µí•´ ì„œë¹„ìŠ¤ ê°ì§€ë¨**\n";
            }
            
            reviewComment += "\n### âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸:\n";
            reviewComment += "- âœ… ê° ì„œë¹„ìŠ¤ë³„ í…ŒìŠ¤íŠ¸ í†µê³¼\n";
            reviewComment += "- âœ… ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì™„ë£Œ\n";
            reviewComment += "- âœ… ë³´ì•ˆ ìŠ¤ìº” ì™„ë£Œ\n\n";
            
            reviewComment += "### ğŸ“ ë³€ê²½ëœ íŒŒì¼ë“¤:\n";
            const serviceFiles = {};
            
            files.forEach(file => {
              const pathParts = file.filename.split('/');
              if (pathParts[0] === 'services' && pathParts.length > 1) {
                const serviceName = pathParts[1];
                if (!serviceFiles[serviceName]) {
                  serviceFiles[serviceName] = [];
                }
                serviceFiles[serviceName].push({
                  name: file.filename,
                  additions: file.additions,
                  deletions: file.deletions
                });
              }
            });
            
            Object.keys(serviceFiles).forEach(service => {
              reviewComment += `\n**${service} ì„œë¹„ìŠ¤:**\n`;
              serviceFiles[service].forEach(file => {
                reviewComment += `- \`${file.name}\` (+${file.additions} -${file.deletions})\n`;
              });
            });
            
            reviewComment += "\n### ğŸš€ ë°°í¬ ì •ë³´:\n";
            reviewComment += "- main ë¸Œëœì¹˜ ë¨¸ì§€ ì‹œ ë³€ê²½ëœ ì„œë¹„ìŠ¤ë§Œ ìë™ ë°°í¬ë©ë‹ˆë‹¤\n";
            reviewComment += "- ê° ì„œë¹„ìŠ¤ëŠ” ë…ë¦½ì ìœ¼ë¡œ ë¹Œë“œ/ë°°í¬ë©ë‹ˆë‹¤\n";
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: reviewComment
            });