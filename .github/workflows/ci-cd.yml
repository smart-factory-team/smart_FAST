# .github/workflows/ci-cd.yml
name: Smart FAST Multi-Service CI/CD Pipeline

on:
  pull_request:
    branches: [ main ]
    paths:
      - 'services/**'
  push:
    branches: [ main ]
    paths:
      - 'services/**'

permissions:
  contents: read
  pull-requests: write
  checks: write
  actions: read
  packages: write
  id-token: write

env:
  REGISTRY: 23acr.azurecr.io
  AKS_CLUSTER_NAME: 23-aks
  AKS_RESOURCE_GROUP: 23-rsrc

jobs:
  # ë³€ê²½ëœ ì„œë¹„ìŠ¤ ê°ì§€
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.changes.outputs.services }}
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      detection_method: ${{ steps.changes.outputs.detection_method }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed services
        id: changes
        run: |
          CHANGED_SERVICES=""
          DETECTION_METHOD=""
          
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # PR ì œëª©ì—ì„œ ì„œë¹„ìŠ¤ëª… ì¶”ì¶œ
            PR_TITLE="${{ github.event.pull_request.title }}"
            SERVICE_NAME=$(echo "$PR_TITLE" | sed -n 's/^[^/]*\/[0-9]\+\/\([^:]*\):.*/\1/p' | sed 's/[[:space:]]*$//' | tr -cd '[:alnum:]-')
          
            echo "ğŸ” PR Title: $PR_TITLE"
            echo "ğŸ” Parsed Service: '$SERVICE_NAME'"
            echo "ğŸ” Length: ${#SERVICE_NAME}"
          
            # ì„œë¹„ìŠ¤ ë””ë ‰í† ë¦¬ í™•ì¸
            if [ -d "services/$SERVICE_NAME" ]; then
              echo "âœ… Service directory found: services/$SERVICE_NAME"
              SERVICES="$SERVICE_NAME"
            else
              echo "âŒ Service directory not found: services/$SERVICE_NAME"
              SERVICES=""
            fi
          fi
          
          # PR ì œëª©ì—ì„œ ê°ì§€ ì‹¤íŒ¨í•˜ê±°ë‚˜ Push ì´ë²¤íŠ¸ì¸ ê²½ìš° git diff ì‚¬ìš©
          if [ -z "$CHANGED_SERVICES" ]; then
            echo "ğŸ” Using git diff to detect changes..."
            if [ "${{ github.event_name }}" == "pull_request" ]; then
              BASE_SHA="${{ github.event.pull_request.base.sha }}"
              HEAD_SHA="${{ github.event.pull_request.head.sha }}"
            else
              BASE_SHA="${{ github.event.before }}"
              HEAD_SHA="${{ github.sha }}"
            fi
          
            # ë³€ê²½ëœ ì„œë¹„ìŠ¤ ë””ë ‰í† ë¦¬ ì°¾ê¸°
            CHANGED_SERVICES=$(git diff --name-only $BASE_SHA $HEAD_SHA | grep '^services/' | cut -d'/' -f2 | sort -u | tr '\n' ' ')
            DETECTION_METHOD="git_diff"
          
            if [ -z "$CHANGED_SERVICES" ]; then
              echo "ğŸ“­ No services changed"
            else
              echo "ğŸ“¦ Services changed: $CHANGED_SERVICES"
            fi
          fi
          
          echo "services=$CHANGED_SERVICES" >> $GITHUB_OUTPUT
          echo "detection_method=$DETECTION_METHOD" >> $GITHUB_OUTPUT

      - name: Set matrix for changed services
        id: set-matrix
        run: |
          SERVICES="${{ steps.changes.outputs.services }}"
          if [ -z "$SERVICES" ]; then
            echo "matrix=[]" >> $GITHUB_OUTPUT
          else
            # JSON ë°°ì—´ í˜•íƒœë¡œ ë³€í™˜
            MATRIX_JSON=$(echo $SERVICES | tr ' ' '\n' | jq -R . | jq -s -c .)
            echo "matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          fi
          
          echo "ğŸ¯ Final matrix: $MATRIX_JSON"

  # ê° ì„œë¹„ìŠ¤ë³„ í…ŒìŠ¤íŠ¸ ë° ë¦°íŒ…
  test-and-lint:
    needs: detect-changes
    if: github.event_name == 'pull_request' && needs.detect-changes.outputs.services != ''
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Check if service directory exists
        id: check-service
        run: |
          if [ -d "services/${{ matrix.service }}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Service directory services/${{ matrix.service }} does not exist"
          fi

      - name: Set environment variable for ${{ matrix.service }}
        if: steps.check-service.outputs.exists == 'true'
        run: |
          echo "AZURE_CONNECTION_STRING=${{ secrets.AZURE_CONNECTION_STRING }}" >> $GITHUB_ENV

      - name: Install dependencies for ${{ matrix.service }}
        if: steps.check-service.outputs.exists == 'true'
        working-directory: services/${{ matrix.service }}
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
          pip install pytest pytest-cov flake8 mypy

      - name: Linting (Flake8) - ${{ matrix.service }}
        id: lint
        if: steps.check-service.outputs.exists == 'true'
        working-directory: services/${{ matrix.service }}
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics > flake8-results.txt 2>&1 || true
          LINT_ERRORS=$(grep -c "E9\|F63\|F7\|F82" flake8-results.txt 2>/dev/null || echo "0")
          
          # ì•ˆì „í•˜ê²Œ output ì“°ê¸°
          {
            echo "lint_errors=${LINT_ERRORS}"
            echo "service_name=${{ matrix.service }}"
          } >> "$GITHUB_OUTPUT"

      - name: Run tests with coverage - ${{ matrix.service }}
        id: test
        if: steps.check-service.outputs.exists == 'true'
        working-directory: services/${{ matrix.service }}
        run: |
          if [ -f "test_*.py" ] || [ -d "tests" ]; then
            pytest --cov=. --cov-report=xml --cov-report=term-missing --junitxml=test-results.xml || true
          
            # í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì‹±
            if [ -f test-results.xml ]; then
              TOTAL=$(grep -o 'tests="[^"]*"' test-results.xml | grep -o '[0-9]*' || echo "0")
              FAILURES=$(grep -o 'failures="[^"]*"' test-results.xml | grep -o '[0-9]*' || echo "0")
              ERRORS=$(grep -o 'errors="[^"]*"' test-results.xml | grep -o '[0-9]*' || echo "0")
              SKIPPED=$(grep -o 'skipped="[^"]*"' test-results.xml | grep -o '[0-9]*' || echo "0")
              PASSED=$((TOTAL - FAILURES - ERRORS))
            else
              TOTAL=0; PASSED=0; FAILURES=0; ERRORS=0; SKIPPED=0
            fi
          
            # ì»¤ë²„ë¦¬ì§€ íŒŒì‹±
            if [ -f coverage.xml ]; then
              COVERAGE=$(grep -o 'line-rate="[^"]*"' coverage.xml | head -1 | grep -o '[0-9.]*' | awk '{print int($1*100)}' || echo "0")
            else
              COVERAGE="0"
            fi
          
            echo "total_tests=$TOTAL" >> $GITHUB_OUTPUT
            echo "passed_tests=$PASSED" >> $GITHUB_OUTPUT
            echo "failed_tests=$((FAILURES + ERRORS))" >> $GITHUB_OUTPUT
            echo "skipped_tests=$SKIPPED" >> $GITHUB_OUTPUT
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
            echo "service_name=${{ matrix.service }}" >> $GITHUB_OUTPUT
          else
            echo "No tests found for ${{ matrix.service }}"
            echo "total_tests=0" >> $GITHUB_OUTPUT
            echo "service_name=${{ matrix.service }}" >> $GITHUB_OUTPUT
          fi

      - name: Upload test results - ${{ matrix.service }}
        if: steps.check-service.outputs.exists == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.service }}
          path: |
            services/${{ matrix.service }}/test-results.xml
            services/${{ matrix.service }}/coverage.xml
            services/${{ matrix.service }}/flake8-results.txt
      

  # ê° ì„œë¹„ìŠ¤ë³„ ë³´ì•ˆ ìŠ¤ìº”
  security-scan:
    needs: detect-changes
    if: github.event_name == 'pull_request' && needs.detect-changes.outputs.services != ''
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Run Bandit security scan - ${{ matrix.service }}
        id: security
        working-directory: services/${{ matrix.service }}
        run: |
          pip install bandit
          bandit -r . -f json -o bandit-report.json || true
          
          # ë³´ì•ˆ ì´ìŠˆ íŒŒì‹±
          if [ -f bandit-report.json ]; then
            HIGH=$(jq '[.results[] | select(.issue_severity=="HIGH")] | length' bandit-report.json || echo "0")
            MEDIUM=$(jq '[.results[] | select(.issue_severity=="MEDIUM")] | length' bandit-report.json || echo "0")
            LOW=$(jq '[.results[] | select(.issue_severity=="LOW")] | length' bandit-report.json || echo "0")
            TOTAL=$((HIGH + MEDIUM + LOW))
          else
            HIGH=0; MEDIUM=0; LOW=0; TOTAL=0
          fi

          echo "high_issues=$HIGH" >> $GITHUB_OUTPUT
          echo "medium_issues=$MEDIUM" >> $GITHUB_OUTPUT
          echo "low_issues=$LOW" >> $GITHUB_OUTPUT
          echo "total_issues=$TOTAL" >> $GITHUB_OUTPUT
          echo "service_name=${{ matrix.service }}" >> $GITHUB_OUTPUT

      - name: Upload security scan results - ${{ matrix.service }}
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-${{ matrix.service }}
          path: services/${{ matrix.service }}/bandit-report.json


  # ê²°ê³¼ í†µí•© Job ì¶”ê°€
  aggregate-results:
    needs: [ detect-changes, test-and-lint, security-scan ]
    if: github.event_name == 'pull_request' && always() && needs.detect-changes.outputs.services != ''
    runs-on: ubuntu-latest
    outputs:
      total_tests: ${{ steps.aggregate.outputs.total_tests }}
      passed_tests: ${{ steps.aggregate.outputs.passed_tests }}
      failed_tests: ${{ steps.aggregate.outputs.failed_tests }}
      skipped_tests: ${{ steps.aggregate.outputs.skipped_tests }}
      coverage: ${{ steps.aggregate.outputs.coverage }}
      lint_errors: ${{ steps.aggregate.outputs.lint_errors }}
      high_issues: ${{ steps.aggregate.outputs.high_issues }}
      medium_issues: ${{ steps.aggregate.outputs.medium_issues }}
      low_issues: ${{ steps.aggregate.outputs.low_issues }}
      total_issues: ${{ steps.aggregate.outputs.total_issues }}
      failed_test_names: ${{ steps.aggregate.outputs.failed_test_names }}

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Aggregate results
        id: aggregate
        run: |
          # ëª¨ë“  í…ŒìŠ¤íŠ¸ ê²°ê³¼ í†µí•©
          TOTAL_TESTS=0
          PASSED_TESTS=0
          FAILED_TESTS=0
          SKIPPED_TESTS=0
          TOTAL_LINT_ERRORS=0
          TOTAL_HIGH=0
          TOTAL_MEDIUM=0
          TOTAL_LOW=0
          FAILED_TEST_NAMES=""
          TOTAL_COVERAGE=0
          SERVICE_COUNT=0

          # ê° ì„œë¹„ìŠ¤ë³„ ê²°ê³¼ ì§‘ê³„
          for dir in test-results-*; do
            if [ -d "$dir" ]; then
              SERVICE_COUNT=$((SERVICE_COUNT + 1))

              # í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì‹± (artifactì—ì„œ)
              if [ -f "$dir/test-results.xml" ]; then
                T=$(grep -o 'tests="[^"]*"' "$dir/test-results.xml" | grep -o '[0-9]*' || echo "0")
                F=$(grep -o 'failures="[^"]*"' "$dir/test-results.xml" | grep -o '[0-9]*' || echo "0")
                E=$(grep -o 'errors="[^"]*"' "$dir/test-results.xml" | grep -o '[0-9]*' || echo "0")
                S=$(grep -o 'skipped="[^"]*"' "$dir/test-results.xml" | grep -o '[0-9]*' || echo "0")

                TOTAL_TESTS=$((TOTAL_TESTS + T))
                FAILED_TESTS=$((FAILED_TESTS + F + E))
                SKIPPED_TESTS=$((SKIPPED_TESTS + S))
                PASSED_TESTS=$((PASSED_TESTS + T - F - E))

                # ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ ì´ë¦„ ìˆ˜ì§‘
                if [ $((F + E)) -gt 0 ]; then
                  SERVICE_NAME=$(echo "$dir" | sed 's/test-results-//')
                  FAILED_TEST_NAMES="$FAILED_TEST_NAMES,$SERVICE_NAME"
                fi
              fi

              # ì»¤ë²„ë¦¬ì§€ ì§‘ê³„
              if [ -f "$dir/coverage.xml" ]; then
                COV=$(grep -o 'line-rate="[^"]*"' "$dir/coverage.xml" | head -1 | grep -o '[0-9.]*' | awk '{print $1*100}' || echo "0")
                TOTAL_COVERAGE=$((TOTAL_COVERAGE + COV))
              fi

              # ë¦°íŠ¸ ì˜¤ë¥˜ ì§‘ê³„
              if [ -f "$dir/flake8-results.txt" ]; then
                LINT_ERR=$(grep -c "E9\|F63\|F7\|F82" "$dir/flake8-results.txt" || echo "0")
                TOTAL_LINT_ERRORS=$((TOTAL_LINT_ERRORS + LINT_ERR))
              fi
            fi
          done

          # ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼ ì§‘ê³„
          for dir in security-scan-*; do
            if [ -d "$dir" ] && [ -f "$dir/bandit-report.json" ]; then
              H=$(jq '[.results[] | select(.issue_severity=="HIGH")] | length' "$dir/bandit-report.json" || echo "0")
              M=$(jq '[.results[] | select(.issue_severity=="MEDIUM")] | length' "$dir/bandit-report.json" || echo "0")
              L=$(jq '[.results[] | select(.issue_severity=="LOW")] | length' "$dir/bandit-report.json" || echo "0")

              TOTAL_HIGH=$((TOTAL_HIGH + H))
              TOTAL_MEDIUM=$((TOTAL_MEDIUM + M))
              TOTAL_LOW=$((TOTAL_LOW + L))
            fi
          done

          # í‰ê·  ì»¤ë²„ë¦¬ì§€ ê³„ì‚°
          if [ $SERVICE_COUNT -gt 0 ]; then
            AVG_COVERAGE=$((TOTAL_COVERAGE / SERVICE_COUNT))
          else
            AVG_COVERAGE=0
          fi

          # Outputs ì„¤ì •
          echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "passed_tests=$PASSED_TESTS" >> $GITHUB_OUTPUT
          echo "failed_tests=$FAILED_TESTS" >> $GITHUB_OUTPUT
          echo "skipped_tests=$SKIPPED_TESTS" >> $GITHUB_OUTPUT
          echo "coverage=$AVG_COVERAGE" >> $GITHUB_OUTPUT
          echo "lint_errors=$TOTAL_LINT_ERRORS" >> $GITHUB_OUTPUT
          echo "high_issues=$TOTAL_HIGH" >> $GITHUB_OUTPUT
          echo "medium_issues=$TOTAL_MEDIUM" >> $GITHUB_OUTPUT
          echo "low_issues=$TOTAL_LOW" >> $GITHUB_OUTPUT
          echo "total_issues=$((TOTAL_HIGH + TOTAL_MEDIUM + TOTAL_LOW))" >> $GITHUB_OUTPUT
          echo "failed_test_names=${FAILED_TEST_NAMES#,}" >> $GITHUB_OUTPUT

  # ê° ì„œë¹„ìŠ¤ë³„ Docker ë¹Œë“œ ë° í‘¸ì‹œ (main ë¸Œëœì¹˜ë§Œ)
  build-and-push:
    needs: detect-changes
    if: github.ref == 'refs/heads/main' && needs.detect-changes.outputs.services != ''
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Check if Dockerfile exists for ${{ matrix.service }}
        id: dockerfile-check
        run: |
          if [ -f "services/${{ matrix.service }}/Dockerfile" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Dockerfile not found for services/${{ matrix.service }}"
          fi

      - name: Login to Azure Container Registry
        if: steps.dockerfile-check.outputs.exists == 'true'
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Build and push Docker image - ${{ matrix.service }}
        if: steps.dockerfile-check.outputs.exists == 'true'
        working-directory: services/${{ matrix.service }}
        run: |
          IMAGE_NAME="smart-fast-${{ matrix.service }}"
          docker build -t ${{ env.REGISTRY }}/${IMAGE_NAME}:${{ github.sha }} .
          docker build -t ${{ env.REGISTRY }}/${IMAGE_NAME}:latest .
          docker push ${{ env.REGISTRY }}/${IMAGE_NAME}:${{ github.sha }}
          docker push ${{ env.REGISTRY }}/${IMAGE_NAME}:latest
          
          echo "Built and pushed image: ${{ env.REGISTRY }}/${IMAGE_NAME}:${{ github.sha }}"

  # ê° ì„œë¹„ìŠ¤ë³„ AKS ë°°í¬
  deploy-to-aks:
    needs: [detect-changes, build-and-push]
    if: github.ref == 'refs/heads/main' && needs.detect-changes.outputs.services != ''
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.detect-changes.outputs.matrix) }}
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS credentials
        run: |
          az aks get-credentials --resource-group ${{ env.AKS_RESOURCE_GROUP }} --name ${{ env.AKS_CLUSTER_NAME }}

      - name: Check if k8s manifests exist for ${{ matrix.service }}
        id: k8s-check
        run: |
          if [ -d "services/${{ matrix.service }}/k8s" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "k8s_path=services/${{ matrix.service }}/k8s" >> $GITHUB_OUTPUT
          elif [ -d "k8s/common" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "k8s_path=k8s/common" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Using unified AI-friendly manifests"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Kubernetes manifests not found for ${{ matrix.service }}"
          fi

      - name: Deploy to AKS - ${{ matrix.service }}
        if: steps.k8s-check.outputs.exists == 'true'
        run: |
          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          export SERVICE_NAME="${{ matrix.service }}"
          export IMAGE_TAG="${{ github.sha }}"
          export REGISTRY="${{ env.REGISTRY }}"
          export IMAGE_FULL_NAME="${{ env.REGISTRY }}/smart-fast-${{ matrix.service }}:${{ github.sha }}"

          echo "ğŸš€ Deploying ${{ matrix.service }} with minimal setup"

          # ìˆœì°¨ì ìœ¼ë¡œ ë°°í¬ (ì˜ì¡´ì„± ê³ ë ¤)
          echo "ğŸ“¦ Creating namespace..."
          envsubst < k8s/common/namespace.yaml | kubectl apply -f -

          echo "ğŸ”§ Deploying application..."
          envsubst < k8s/common/deployment.yaml | kubectl apply -f -

          echo "ğŸŒ Creating service..."
          envsubst < k8s/common/service.yaml | kubectl apply -f -

          echo "ğŸŒ Setting up ingress..."
          envsubst < k8s/common/ingress.yaml | kubectl apply -f -

          echo "ğŸ“ˆ Configuring auto-scaling..."
          envsubst < k8s/common/hpa.yaml | kubectl apply -f -

          # ë°°í¬ ìƒíƒœ í™•ì¸
          echo "â³ Waiting for deployment to be ready..."
          kubectl rollout status deployment/sf-${{ matrix.service }} -n sf-${{ matrix.service }} --timeout=300s

          # ë°°í¬ ê²°ê³¼ í™•ì¸
          POD_STATUS=$(kubectl get pods -n sf-${{ matrix.service }} -l app=sf-${{ matrix.service }} -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "NotFound")
          if [ "$POD_STATUS" = "Running" ]; then
            echo "âœ… ${{ matrix.service }} deployed successfully!"

            # ì ‘ê·¼ URL ì•ˆë‚´
            EXTERNAL_IP=$(kubectl get service ingress-nginx-controller -n ingress-nginx -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "pending")
            if [ "$EXTERNAL_IP" != "pending" ] && [ ! -z "$EXTERNAL_IP" ]; then
              echo "ğŸŒ Service URL: http://$EXTERNAL_IP.nip.io/v1/${{ matrix.service }}/"
              echo "ğŸ¥ Health Check: http://$EXTERNAL_IP.nip.io/health/${{ matrix.service }}"
            else
              echo "â³ External IP is still being assigned. Check later with: kubectl get ingress -A"
            fi
          else
            echo "âš ï¸ Deployment may have issues. Pod status: $POD_STATUS"
            kubectl describe pods -n sf-${{ matrix.service }} -l app=sf-${{ matrix.service }}
          fi
  # Pull Request ìë™ ë¦¬ë·° (ëª¨ë“  ê²€ì‚¬ ì™„ë£Œ í›„)
  auto-review:
    needs: [ detect-changes, aggregate-results ]
    if: github.event_name == 'pull_request' && needs.detect-changes.outputs.services != '' && always()
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: PR Code Review Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const changedServices = "${{ needs.detect-changes.outputs.services }}".split(' ').filter(s => s.trim());

            if (changedServices.length === 0) {
              console.log('No services detected, skipping review comment');
              return;
            }

            console.log('Changed services:', changedServices);

            try {
              const detectionMethod = "${{ needs.detect-changes.outputs.detection_method }}";
              const prTitle = "${{ github.event.pull_request.title }}";

              // ê° ì‘ì—…ì˜ ê²°ê³¼ ìˆ˜ì§‘
              const testResult = "${{ needs.test-and-lint.result }}";
              const securityResult = "${{ needs.security-scan.result }}";

              // í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì‹±
              const testOutputs = {
                total: "${{ needs.aggregate-results.outputs.total_tests || '0' }}",
                passed: "${{ needs.aggregate-results.outputs.passed_tests || '0' }}",
                failed: "${{ needs.aggregate-results.outputs.failed_tests || '0' }}",
                skipped: "${{ needs.aggregate-results.outputs.skipped_tests || '0' }}",
                coverage: "${{ needs.aggregate-results.outputs.coverage || 'N/A' }}",
                failedTests: "${{ needs.aggregate-results.outputs.failed_test_names || '' }}",
                lintErrors: "${{ needs.aggregate-results.outputs.lint_errors || '0' }}",
                lintWarnings: "${{ needs.aggregate-results.outputs.lint_warnings || '0' }}"
              };

              // ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼
              const securityOutputs = {
                highIssues: "${{ needs.security-scan.outputs.high_issues || '0' }}",
                mediumIssues: "${{ needs.security-scan.outputs.medium_issues || '0' }}",
                lowIssues: "${{ needs.security-scan.outputs.low_issues || '0' }}",
                totalIssues: "${{ needs.security-scan.outputs.total_issues || '0' }}",
                securityDetails: "${{ needs.security-scan.outputs.security_details || '' }}"
              };

              let reviewComment = "## ğŸ¤– Smart FAST ìë™ ì½”ë“œ ë¦¬ë·°\n\n";
              reviewComment += `### ğŸ“¦ ë³€ê²½ëœ ì„œë¹„ìŠ¤ (${changedServices.length}ê°œ):\n`;

              changedServices.forEach(service => {
                reviewComment += `- **${service}** ì„œë¹„ìŠ¤\n`;
              });

              // ê°ì§€ ë°©ë²•ì— ë”°ë¥¸ ë©”ì‹œì§€
              if (detectionMethod === "pr_title") {
                reviewComment += "\nğŸ¯ **PR ì œëª©ì—ì„œ ì„œë¹„ìŠ¤ ìë™ ê°ì§€ë¨**\n";
                reviewComment += `- ì œëª©: \`${prTitle}\`\n`;
              } else if (detectionMethod === "git_diff") {
                reviewComment += "\nğŸ” **Git diffë¥¼ í†µí•´ ì„œë¹„ìŠ¤ ê°ì§€ë¨**\n";
              }

              // ì „ì²´ ìƒíƒœ ìš”ì•½
              reviewComment += "\n### ğŸ“Š ì „ì²´ ê²€ì‚¬ ê²°ê³¼:\n";
              const allPassed = testResult === 'success' && securityResult === 'success';

              if (allPassed) {
                reviewComment += "âœ… **ëª¨ë“  ê²€ì‚¬ í†µê³¼** - ë°°í¬ ì¤€ë¹„ ì™„ë£Œ!\n";
              } else {
                reviewComment += "âš ï¸ **ì¼ë¶€ ê²€ì‚¬ì—ì„œ ë¬¸ì œ ë°œê²¬** - í™•ì¸ í•„ìš”\n";
              }

              // í…ŒìŠ¤íŠ¸ & ë¦°íŠ¸ ê²°ê³¼ ì„¹ì…˜
              reviewComment += "\n### ğŸ§ª í…ŒìŠ¤íŠ¸ & ì½”ë“œ í’ˆì§ˆ ê²°ê³¼:\n";

              if (testResult === 'success') {
                reviewComment += "âœ… **í…ŒìŠ¤íŠ¸ & ë¦°íŠ¸ í†µê³¼**\n";
              } else if (testResult === 'failure') {
                reviewComment += "âŒ **í…ŒìŠ¤íŠ¸ & ë¦°íŠ¸ ì‹¤íŒ¨**\n";
              } else if (testResult === 'skipped') {
                reviewComment += "â­ï¸ **í…ŒìŠ¤íŠ¸ & ë¦°íŠ¸ ìŠ¤í‚µë¨**\n";
              } else {
                reviewComment += "âš ï¸ **í…ŒìŠ¤íŠ¸ & ë¦°íŠ¸ ìƒíƒœ ë¶ˆëª…**\n";
              }

              // í…ŒìŠ¤íŠ¸ í†µê³„
              if (testOutputs.total !== '0') {
                reviewComment += `- **ì´ í…ŒìŠ¤íŠ¸**: ${testOutputs.total}ê°œ\n`;
                reviewComment += `- **ì„±ê³µ**: ${testOutputs.passed}ê°œ âœ…\n`;

                if (testOutputs.failed !== '0') {
                  reviewComment += `- **ì‹¤íŒ¨**: ${testOutputs.failed}ê°œ âŒ\n`;
                }

                if (testOutputs.skipped !== '0') {
                  reviewComment += `- **ìŠ¤í‚µ**: ${testOutputs.skipped}ê°œ â­ï¸\n`;
                }

                if (testOutputs.coverage !== 'N/A') {
                  reviewComment += `- **ì»¤ë²„ë¦¬ì§€**: ${testOutputs.coverage}%\n`;
                }
              }

              // ë¦°íŠ¸ ê²°ê³¼
              if (testOutputs.lintErrors !== '0' || testOutputs.lintWarnings !== '0') {
                reviewComment += `- **ë¦°íŠ¸ ì˜¤ë¥˜**: ${testOutputs.lintErrors}ê°œ\n`;
                reviewComment += `- **ë¦°íŠ¸ ê²½ê³ **: ${testOutputs.lintWarnings}ê°œ\n`;
              }

              // ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ ìƒì„¸ ì •ë³´
              if (testOutputs.failedTests) {
                reviewComment += "\n**ğŸ” ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸:**\n";
                const failedTestsList = testOutputs.failedTests.split(',').filter(t => t.trim());
                failedTestsList.forEach(test => {
                  reviewComment += `- \`${test.trim()}\`\n`;
                });
              }

              // ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼ ì„¹ì…˜
              reviewComment += "\n### ğŸ”’ ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼:\n";

              if (securityResult === 'success') {
                reviewComment += "âœ… **ë³´ì•ˆ ê²€ì‚¬ í†µê³¼**\n";
              } else if (securityResult === 'failure') {
                reviewComment += "âŒ **ë³´ì•ˆ ì´ìŠˆ ë°œê²¬**\n";
              } else if (securityResult === 'skipped') {
                reviewComment += "â­ï¸ **ë³´ì•ˆ ìŠ¤ìº” ìŠ¤í‚µë¨**\n";
              } else {
                reviewComment += "âš ï¸ **ë³´ì•ˆ ìŠ¤ìº” ìƒíƒœ ë¶ˆëª…**\n";
              }

              if (securityOutputs.totalIssues !== '0') {
                reviewComment += `- **ì´ ë³´ì•ˆ ì´ìŠˆ**: ${securityOutputs.totalIssues}ê°œ\n`;

                if (securityOutputs.highIssues !== '0') {
                  reviewComment += `  - ğŸ”´ **High**: ${securityOutputs.highIssues}ê°œ\n`;
                }
                if (securityOutputs.mediumIssues !== '0') {
                  reviewComment += `  - ğŸŸ¡ **Medium**: ${securityOutputs.mediumIssues}ê°œ\n`;
                }
                if (securityOutputs.lowIssues !== '0') {
                  reviewComment += `  - ğŸŸ¢ **Low**: ${securityOutputs.lowIssues}ê°œ\n`;
                }

                // ë³´ì•ˆ ì´ìŠˆ ìƒì„¸ ì •ë³´
                if (securityOutputs.securityDetails) {
                  reviewComment += "\n**ğŸš¨ ì£¼ìš” ë³´ì•ˆ ì´ìŠˆ:**\n";
                  const securityDetailsList = securityOutputs.securityDetails.split(',').filter(d => d.trim());
                  securityDetailsList.forEach(detail => {
                    reviewComment += `- ${detail.trim()}\n`;
                  });
                }
              } else {
                reviewComment += "- ë³´ì•ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤ âœ…\n";
              }

              // ì¢…í•© ì²´í¬ë¦¬ìŠ¤íŠ¸
              reviewComment += "\n### âœ… ê²€ì‚¬ ì²´í¬ë¦¬ìŠ¤íŠ¸:\n";
              reviewComment += testResult === 'success' ? 
                "- âœ… í…ŒìŠ¤íŠ¸ í†µê³¼\n" : 
                "- âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨\n";
              reviewComment += testOutputs.lintErrors === '0' ? 
                "- âœ… ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ í†µê³¼\n" : 
                "- âŒ ë¦°íŠ¸ ì˜¤ë¥˜ ë°œê²¬\n";
              reviewComment += securityResult === 'success' ? 
                "- âœ… ë³´ì•ˆ ìŠ¤ìº” í†µê³¼\n" : 
                "- âŒ ë³´ì•ˆ ì´ìŠˆ ë°œê²¬\n";

              // ë°°í¬ ì •ë³´
              reviewComment += "\n### ğŸš€ ë°°í¬ ì •ë³´:\n";
              if (allPassed) {
                reviewComment += "- âœ… **ëª¨ë“  ê²€ì‚¬ í†µê³¼** - ë°°í¬ ì¤€ë¹„ ì™„ë£Œ\n";
                reviewComment += "- ğŸ”„ main ë¸Œëœì¹˜ ë¨¸ì§€ ì‹œ ìë™ ë°°í¬ë©ë‹ˆë‹¤\n";
                reviewComment += "- ğŸ—ï¸ ê° ì„œë¹„ìŠ¤ëŠ” ë…ë¦½ì ìœ¼ë¡œ ë¹Œë“œ/ë°°í¬ë©ë‹ˆë‹¤\n";
              } else {
                reviewComment += "- âš ï¸ **ê²€ì‚¬ ì‹¤íŒ¨** - ë¬¸ì œ í•´ê²° í›„ ë°°í¬ ê°€ëŠ¥\n";
                if (testResult !== 'success') {
                  reviewComment += "  - ğŸ§ª í…ŒìŠ¤íŠ¸ ë¬¸ì œ í•´ê²° í•„ìš”\n";
                }
                if (securityResult !== 'success') {
                  reviewComment += "  - ğŸ”’ ë³´ì•ˆ ì´ìŠˆ í•´ê²° í•„ìš”\n";
                }
              }
              reviewComment += "- ğŸ“‹ ìƒì„¸ ë¡œê·¸ëŠ” Actions íƒ­ì—ì„œ í™•ì¸ ê°€ëŠ¥\n";

              // ê¸°ì¡´ ìë™ ë¦¬ë·° ì½”ë©˜íŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ì—…ë°ì´íŠ¸
              const { data: comments } = await github.rest.issues.listComments({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
              });

              const botComment = comments.find(comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes('ğŸ¤– Smart FAST ìë™ ì½”ë“œ ë¦¬ë·°')
              );

              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: reviewComment
                });
                console.log('Updated existing review comment');
              } else {
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: reviewComment
                });
                console.log('Created new review comment');
              }

            } catch (error) {
              console.error('Error creating review comment:', error);
              process.exit(0);
            }
